<!doctype html>

<html>
<head>
  <link rel="stylesheet" href="../node_modules/xterm/css/xterm.css" />
  <script src="socket.io/socket.io.js"></script>
  <script src="../node_modules/xterm/lib/xterm.js"></script>
</head>

<body>
  <div id="terminal"></div>
  <script>
    var term = new Terminal();

    message = "xTermEmulator"
    term.prompt = function() {
        term.write(`\r\n${message}$ `);
    };

    term.welcome = function() {
      term.write('\r\nHello from \x1B[1;3;31mxterm.js\x1B[0m $ ');
    };

    term.open(document.getElementById('terminal'));
    term.welcome();

    var socketTx = io();
    var socketRx = io.connect();

    // Consider buffer.getLine
    let data = ""; 
    term.onKey(function(e) {
      console.log(e);
      const ev = e.domEvent;
      const printable = !ev.altKey && !ev.ctrlKey && !ev.metaKey;

      if (ev.keyCode === 13) {
        if (data == "clear") {
          console.log("Clearing Terminal");
          term.clear();
          term.welcome();
        } else {
        socketTx.emit('data', data);
        console.log("Data transmitted TO pty:" + data);
        }
        data = "";
      } else if (ev.keyCode === 8 || ev.keyCode === 127) {
       // Do not delete the prompt
        if (term._core.buffer.x > 5) {
          term.write('\b \b');
          data = data.slice(0, -1);
        }
      } else if (ev.keyCode === 38){ // 37:left, 38:up, 39:right, 40:down
	  socketTx.emit('data', 'history 1');
	  term.write('\033[B');
      }	else if (ev.keyCode === 40) {
          term.write('\033[A');
      }	else if (printable) {
          data += ev.key;
	  term.write(ev.key);
	  console.log(data);
      }
    });

    term.onData(function (event) {
        if (event.length > 1) {  
	  data += event;
          term.write(event);
	}
    })

    socketRx.on('data', function(data){
      term.write(data);
      console.log("Data received FROM pty:" + data);
    });

  </script>

</body>
</html>
